## application.yml 配置

### datasource 
### 持久层框架 MyBatis 相关配置
```yaml
mybatis:
  mapper-locations: classpath:mapper/*Mapper.xml  #mapper 映射文件路径
  type-aliases-package: com.example.vuemanage.domain  #别名
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
```
---
## 创建实体类 
### domain 包下 User.java

---

## 实现 查询所有 方法
### 创建 接口：UserMapper.java 
#### 需要给该接口 使用注解：@Mapper
```java
//      查询所有
       @Select("select * from sys_user")
       public List<User> findAll();
```
### 新建controller 包，下新建 Controller类
#### UserController.java
#### 需要给该接口 使用注解：@RestController @RequestMapping(value = "/user")
 - 使用`@Resource`给需要注入的`mapper`文件 添加注解，使springboot框架识别
 ```java
    @Resource
    private UserMapper userMapper;
 ```
 - 实现查询所有方法
 ```java
//    返回所有用户
        @GetMapping("/")
        public List<User> demo(){
            return userMapper.findAll();
        }
 ```
---
## 实现新增方法 
### 接口：UserMapper.java 
#### 直接在该文件下 新建增加方法 insert();
```java
 //    新增
    @Insert("insert into sys_user(username,password,nickname,email,phone,address)" +
            " values(#{username},#{password},#{nickname},#{email},#{phone},#{address})")
    public int insert(User user);
```
### 新建Service 包，下新建UserService.java，间接使用业务层操作方法
- 使用`@Resource`给需要注入的`mapper`文件 添加注解，使springboot框架识别
 ```java
    @Resource
    private UserMapper userMapper;
 ```
 - 创建方法 `save(User user){}`
 ```java
 public int save(User user){
    if(user.getId == null){ //如果用户的id不存在，则新 增加
        return userMapper.insert(user);   
    }else{
        //此处用于在用户id 存在的情况下，调用update(user)方法
    }
 } 
 ```

#### UserController.java
 - 使用注解引入 UserService.java资源，@Autowired
  ```java
  @Autowired
  private UserService userService;
  ```
 - 调用 UserService.java 中的 save(User user)方法
 ```java
 //    新增 或者 更新
     @PostMapping("/add")
     public Integer save(@RequestBody User user){
         return userService.save(user);
     }
    @RequestBody 用于声明方法参数，接收前端的参数，前端的请求方法需要使用 Post 方法
 ```
---

### 实现更新 update(User user)
#### 在 UserMapper.java 接口中，创建update(User user);
```java
 int update(User user);
```
##### 注意更新方法，如果直接在方法上使用注解 @Update("),会导入一些为更改的数据丢失
所以这里使用`*Mapper.xml`映射文件的方式，实现
 - 在resources资源包下，新建mapper包，`UserMapper.xml`
 - 引入命名空间，指到`UserMapper.java`所在全相对地址
 ```xml
 <mapper namespace="com.example.vuemanage.mapper.UserMapper"></mapper>
 注意：记得在配置文件 yml 中，否则会报找不到mapper资源异常
    mapper-locations: classpath:mapper/*Mapper.xml  #mapper 映射文件路径
 ```
 - 使用MyBatis框架提供的`<update> + <set> + <if> + <where> `标签 
 ```xml-dtd
 <update id="update">
         update sys_user
             <set>
                 <if test="username != null">
                     username=#{username},
                 </if>
 <!--                <if test="password != null">-->
 <!--                    password=#{password}-->
 <!--                </if>-->
                 <if test="nickname != null">
                     nickname=#{nickname},
                 </if>
                 <if test="email != null">
                     email=#{email},
                 </if>
                 <if test="phone != null">
                     phone=#{phone},
                 </if>
                 <if test="address != null">
                     address=#{address}
                 </if>
             </set>
             <where>
                 id=#{id}
             </where>
     </update>
 ```
#### xml文件配置完成后，在UserMapper.java 接口中 声明映射的 方法
    注意：接口中的方法名 必须要与 映射文件中 方法 的 id 一致！
    比如：xml中：<update id="update"> -- 接口中 int update(User user);

#### 在业务层`UserService`中调用 UserMapper 接口方法
```java
更新方法与新增方法 集合到一起判断 根据 用户id是否存在
可在该save()方法的 else 语句中 调用
else{
    return userMapper.update(user);
}
```

#### 在web层`UserController` 中调用 UserService 的 save(user)方法

---

### 实现 根据 用户 id 进行删除操作
#### 因为此时 删除语句比较简单，则可直接在 `UserMapper`接口中使用注解完成
```java
@Delete("delete from sys_user where id = #{id})
Integer deleteById(@Param("id") Integer id);    
//此处的`@Param`中的 id 为需要传入SQL语句的 id 赋值
如果需要为 SQL 语句中多个属性赋值，可以声明多个 @Param(),
```

#### 此时为测试需要，直接在 Web层 `UserController` 中调用
```java
//    根据 id 删除
    @DeleteMapping("/{id}") //其中的id @PathVariable 声明的 id 对应
    public Integer delete(@PathVariable Integer id){
        return userMapper.deleteById(id);
    }
//  @PathVariable 映射 URL 绑定的占位符
    通过 @PathVariable 可以将 URL 中占位符参数绑定到控制器处理方法的入参中:
    URL 中的 {xxx} 占位符可以通过@PathVariable(“xxx”) 绑定到操作方法的入参中。
使用Apifox测试 时，直接在路径 /user/ 后传入需要删除的 id即可
```
---

### 分页查询
#### 在 Dao 层 `UserMapper` 中
    编写两个接口方法：
 - 一个是查询并记录 所有条数的 方法--selectTotal();
```java
@Select("select count(*) from sys_user")
Integer selectTotal();
```
 - 一个是根据`页码` `条数`进行分页查询
 ```java
@Select("select * from sys_user limit #{pageNum}, #{pageSize}")
List<User> findByPage(Integer pageNum,Integer pageSize);
 ```
#### 在 Web 层 `UserController` 中
    编写 Map<String,Object> 类型查询方法，将查询的 数据封装至 map 集合
```java
//其中@RequestParam 用于接收 /user/page?pageNum=1&pageSize=3
//  limit (pageNum -1) * pageSize, pageSize
//  第一页：limit (1-1)*3, 3
@GetMapping("/page")
public Map<String,Object> findByPage(@RequestParam Integer pageNum,
                                     @RequestParam Integer pageSize){
    // 返回总条数
    Integer total = userMapper.selectTotal();

    // Map 集合封装
    Map<String,Object> map = new HashMap<>();
    map.put("total",total);
    map.put("当前页",pageNum);

    // 分页计算
    pageNum = (pageNum - 1) * pageSize;
    List<User> data = userMapper.findByPage(pageNum,pageSize);
    map.put("data",date);
    
    return map;
}
```
---
### 前端使用 接口 调用数据
#### 使用 fetch()
```js
fetch().then(res => res.json()).then(res =>{})
fetch("http://localhost:8081/user/page?pageNum="+this.pageNum+"&pageSize="+this.pageSize)
    .then(res => res.json()).then(res =>{   // 使用了 `箭头函数`,先将res转为 json 返回并赋值给本身
                                            // 然后再 使用箭头函数 ，将res对象的数据 赋值给 全局的变量
            this.tableData = res.data;  //res.data 是指 请求的json中的数据
            this.total = res.total;
        })
this.tableData --> 在data(){return{}} 中，tableData:[] ，将该变量绑定到 表格中：:data="tableData"
this.total -->定义：total:0 默认值，会根据调用方法后动态赋值,在 分页块中绑定：:total="total"
 
将上面方法封装至 load(){} 方法中
然后在 data(){}后 定义 create(){ },在该方法内 调用load() --> this.load();

```
```vue
<el-pagination
      @size-change="handleSizeChange"
      @current-change="handleCurrentChange"
      :current-page="pageNum"
      :page-sizes="[2, 5, 10, 20]"
      :page-size="pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="total">
 </el-pagination>
```
---
#### 将数据 展示在 表格中
```vue
    <el-table-column  prop="id" align="center" label="ID" width="40"></el-table-column>
    <el-table-column prop="username" align="center" label="姓名" width="120"></el-table-column>
    <el-table-column prop="nickname" align="center" label="昵称"></el-table-column>
    <el-table-column prop="phone" align="center" label="电话"></el-table-column>
    <el-table-column prop="address" align="center" label="地址"></el-table-column>
    使用 prop 绑定 数据字段
```
#### 页码相关

 - 绑定页码
 ```vue
    :current-page="pageNum"
    data(){ return{ } }中：
    pageNum:1
 ```
 - 绑定页面条数
 ```json
    :page-size="pageSize"
    data(){ return{ } }中：
    pageSize:3
 ```
 - 绑定分页 条数切换
 ```js
    @size-change="handleSizeChange"
    定义方法：
    handleSizeChange(pageSize) {
            this.pageSize = pageSize;
            this.load();
    }
 ```
 - 绑定分页 当前页码切换
 ```js
    @current-change="handleCurrentChange"
    定义方法：
    handleCurrentChange(pageNum) {
            this.pageNum = pageNum;
            this.load();
    }
 ```
 - 根据用户名 username 分页查询
```
    在搜索框区域 使用 `v-model`,绑定 username，--> v-model="username"，v-model用于双向绑定
    其次在data(){ return(){ } } 中定义：username:''
    最后修改`fetch()`中的请求参数：
        fetch("http://localhost:8081/user/page2?pageNum="+this.pageNum+
        "&pageSize="+this.pageSize+"&username="+this.username)...
    `注意：`需要在 后台代码中 定义了请求路径 `/page2` 的方法
```
 - 以下为 根据用户名 模糊查询的方法(这里暂时使用，后期使用xml映射文件 动态SQL)
```java
    `UserController.java:`
	@GetMapping("/page2")
    public Map<String,Object> findByPage2(@RequestParam Integer pageNum,
                                          @RequestParam Integer pageSize,
                                          @RequestParam String username){

//         使用map 集合 将分页相关 数据 封装
        Map<String,Object> map = new HashMap<>();

        //        分页计算
        pageNum = (pageNum-1 ) * pageSize;
        username = "%" + username + "%" ;
        List<User> dataById = userMapper.findByPage2(pageNum, pageSize,username);
        //        返回总条数
        Integer total = userMapper.selectTotal2(username);
        map.put("data",dataById);
        map.put("total",total);

        return map;
    }
    `UserMapper.xml:`
    @Select("select * from sys_user where username like #{username} limit #{pageNum}, #{pageSize}")
    List<User> findByPage2(Integer pageNum, Integer pageSize,String username);

    @Select("select count(*) from sys_user where username like #{username}")
    Integer selectTotal2(String username);
```
#### 前端跨域
    创建配置类CorsConfig
```java
@Configuration
public class CorsConfig {

    // 当前跨域请求最大有效时长。这里默认1天
    private static final long MAX_AGE = 24 * 60 * 60;

    @Bean
    public CorsFilter corsFilter() {
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        CorsConfiguration corsConfiguration = new CorsConfiguration();
        corsConfiguration.addAllowedOrigin("http://localhost:8080"); // 1 设置访问源地址
        corsConfiguration.addAllowedHeader("*"); // 2 设置访问源请求头
        corsConfiguration.addAllowedMethod("*"); // 3 设置访问源请求方法
        corsConfiguration.setMaxAge(MAX_AGE);
        source.registerCorsConfiguration("/**", corsConfiguration); // 4 对接口配置跨域设置
        return new CorsFilter(source);
    }
}

```

### 分页查询之 根据 用户名、邮箱、地址 模糊查询
 - 方式一：使用`MyBatis`配置`mapper.xml`映射文件
 - 方式二：使用`MyBatis Plus` 调用已定义的内部方法

##### 使用`MyBatis`配置`mapper.xml`映射文件
    在 UserMapper.java 接口中 定义 查询方法，alt+enter自动在mapper.xml文件中
    生成 对应的 查询语句。
 - `UserMapper.java:`
```java
    List<User> findByPage3(Integer pageNum, Integer pageSize,String username,
                            String email,String address);
    Integer selectTotal3(String username,String email,String address);
```
 - `UserMapper.xml:` 
```xml-dtd
    <select id="findByPage3" resultType="com.example.vuemanage.domain.User">
            select * from sys_user
            <where>
                <if test="username != null and username != '' ">
                    and username like #{username}
                </if>
                <if test="email != null and email != '' ">
                    and email like #{email}
                </if>
                <if test="address != null and address != '' ">
                    and address like #{address}
                </if>
            </where>
            limit #{pageNum} , #{pageSize}
    </select>

    <select id="selectTotal3" resultType="java.lang.Integer">
            select count(*) from sys_user
            <where>
                <if test="username != null and username != '' ">
                    and username like #{username}
                </if>
                <if test="email != null and email != '' ">
                    and email like #{email}
                </if>
                <if test="address != null and address != '' ">
                    and address like #{address}
                </if>
            </where>
    </select>
```
###### 在 Web 层 配置页面访问路径对应的查询数据方法
```java
    @GetMapping("/page3")
    public Map<String,Object> findByPage3(@RequestParam Integer pageNum,
                                          @RequestParam Integer pageSize,
                                          @RequestParam(defaultValue = "") String username,
                                          @RequestParam(defaultValue = "") String email,
                                          @RequestParam(defaultValue = "") String address) {


//         使用map 集合 将分页相关 数据 封装
        Map<String, Object> map = new HashMap<>();

        //        分页计算
        pageNum = (pageNum - 1) * pageSize;
        if ( !"".equals(username)) {
            username = "%" + username + "%";
        }
        if ( !"".equals(email)) {
            email = "%" + email + "%";
        }
        if ( !"".equals(address)) {
            address = "%" + address + "%";
        }
        List<User> dataById = userMapper.findByPage3(pageNum, pageSize, username, email, address);
        //        返回总条数
        Integer total = userMapper.selectTotal3(username, email, address);
        map.put("data", dataById);
        map.put("total", total);

        return map;
    }
```
##### 使用`MyBatis Plus` 
 - 首先需要在`pom.xml`中引入依赖
 ```xml-dtd
    <!--        MyBatis Plus-->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>3.5.1</version>
         </dependency>
 ```
 - 创建 配置类 MybatisPlusConfig.java 
 ```java
    @Configuration
    @MapperScan("com.example.vuemanage.mapper") 
    //用于扫描 mapper包下资源，此时mapper下的接口可以不用用@Mapper声明
    public class MybatisPlusConfig {
    
        /**
         * 新的分页插件,一缓和二缓遵循mybatis的规则,需要设置 MybatisConfiguration#useDeprecatedExecutor = false 避免缓存出现问题(该属性会在旧插件移除后一同移除)
         */
        @Bean
        public MybatisPlusInterceptor mybatisPlusInterceptor() {
            MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
            interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
            return interceptor;
        }
    
    }

 ```
 - UserMapper.java接口 需要 继承 BaseMapper<Entity>, 这里Entity 为 User
 - UserService.java 继承 ServiceImpl<UserMapper,User>
 - 新增 或者 更新
 ```java
    `UserService.java`：
        即可定义一个boolean 类型的方法，用于返回是否完成 操作
        public boolean saveUser(User user){ return ;}
    `新增`或者`更新`：
        可直接调用 `saveOrUpdate()`方法，传入 实体类对象 user
        return saveOrUpdate(user);
    `UserController.java`：
        定义访问路径 调用 saveUser(user)
            @PostMapping("/add")
            public boolean save(@RequestBody User user){
        
                return userService.saveUser(user);
            }   
    
 ```
 - 分页查询 -- `mybatis plus`
 控制 web 层 直接操作
```java
    @GetMapping("/page2")
    public IPage<User> findByPage1(@RequestParam Integer pageNum,
                                          @RequestParam Integer pageSize,
                                          @RequestParam(defaultValue = "") String username,
                                          @RequestParam(defaultValue = "") String email,
                                          @RequestParam(defaultValue = "") String address){

        IPage<User> page = new Page<>(pageNum,pageSize);

        QueryWrapper<User> wrapper = new QueryWrapper<>();
        if ( !"".equals(username)){     //用于判断 数据表中 ，值不为空
            wrapper.like("username",username);
        }
        if ( !"".equals(email)){
            wrapper.like("email",email);
        }
        if ( !"".equals(address)){
            wrapper.like("address",address);
        }
        
        // page 方法 为分页
        IPage<User> userIPage = userService.page(page, wrapper);

        return userIPage;
    }
```
- 删除
```java
    @DeleteMapping("/{id}") //其中的id @PathVariable 声明的 id 对应
    public boolean delete(@PathVariable Integer id){
        return userService.removeById(id);  // mybatis plus 提供的 根据id 删除
    }
```

##### 在前端接收数据时
```json
如果是使用 mybatis plus ，会将数据自动 封装成 键为 records 的json数据
 例如：
 {
     "records": [
         {
             "id": 1,
             "username": "user1",
             "nickname": "管理员",
             "email": "admin@email.com",
             "phone": "11111111111",
             "address": "中国江苏"
         }
     ],
     "total": 5,
     "size": 6,
     "current": 1,
     "orders": [],
     "optimizeCountSql": true,
     "searchCount": true,
     "countId": null,
     "maxLimit": null,
     "pages": 1
 }
```

### 前端使用 axios 
#### 安装 axios 包
    npm i axios -S
#### 新增 request.js 文件
    在 src 下新建 utils 包，新建request.js文件
```js
    import axios from 'axios'
    
    const request = axios.create({
        baseURL: '/api',  // 注意！！ 这里是全局统一加上了 '/api' 前缀，也就是说所有接口都会加上'/api'前缀在，页面里面写接口的时候就不要加 '/api'了，否则会出现2个'/api'，类似 '/api/api/user'这样的报错，切记！！！
        timeout: 5000
    });
    
    // request 拦截器
    // 可以自请求发送前对请求做一些处理
    // 比如统一加token，对请求参数统一加密
    request.interceptors.request.use(config => {
        config.headers['Content-Type'] = 'application/json;charset=utf-8';
    
        // config.headers['token'] = user.token;  // 设置请求头
        return config
    }, error => {
        return Promise.reject(error)
    });
    
    // response 拦截器
    // 可以在接口响应后统一处理结果
    request.interceptors.response.use(
        response => {
            let res = response.data;
            // 如果是返回的文件
            if (response.config.responseType === 'blob') {
                return res
            }
            // 兼容服务端返回的字符串数据
            if (typeof res === 'string') {
                res = res ? JSON.parse(res) : res
            }
            return res;
        },
        error => {
            console.log('err' + error); // for debug
            return Promise.reject(error)
        }
    )
    
    
    export default request
```
#### 在 `main.js` 中引入 `request.js`
---
### 新增 用户
#### 引入 dialog 表单
##### 在`https://element.eleme.cn/#/zh-CN` 找到并复制需要 组件至 `HomeView.vue`
 - 定义弹出的表弹窗
  ```vue
    注意：在<el-dialog> 中需要有 :visible.sync="dialogVisible" 
    在 <el-form >中 声明 :model="form" ，后需要定义 form 数据模型：form: {},
    在 表单中的 项中 引用数据模型：v-model="form.username"
    <el-form-item label="姓名">
        <el-input v-model="form.username"></el-input>
    </el-form-item>
  ```
 - 在新增按钮 绑定 新增方法 `handleAdd()`
    ```js
    //新增按钮
    handleAdd(){
         this.dialogVisible = true;
         this.formTitle = '添加用户';
         this.form = {};
    }
   ```
 - 将 表单框 中提交按钮绑定方法 `addUser()`
 ```js
     addUser(){
        // 这里的 url 是因为在reques.js 中 提取出 相同的路径
    /*  const request = axios.create({
            baseURL: 'http://localhost:8081'
    */  
        -------
         request.post("/user/add",this.form).then(resp => {
             if (resp){
                 //    添加成功
                 //    关闭窗口
                 this.dialogVisible = false;
                 this.load();
                 this.$message({
                      message: '操作成功!',
                      type: 'success'
                 });
             }else {
                 this.$message.error("保存失败");
             }
         });
     }
 ```
 - 在取消按钮处 直接绑定方法 `@click="dialogVisible = false" ` 使表单隐藏不显示

### 编辑&更新用户数据
```tex
在 编辑按钮 块域中，父组件 template标签中 声明 slot-scop="scope"
之后给 按钮 绑定 编辑方法，@click="handleEdit(scope.row)
/*
scope.row相当于一个{},{}里边都是数据；按理说，列表里的数据是要供给表单展示，
列表中的每个{}都是结构一样的，或者理解为包含的数据项相同
*/
```
 - 编辑方法
 ```js
      //表格数据操作
      handleEdit(row) {
           // this.form = row;
           this.form = Object.assign({},row); //将row拷贝到空对象中，解决没点确定 表中数据改变的问题
           this.dialogVisible = true;
           this.formTitle = '修改用户信息';
      }
      
 ```
 `由于在后端中 使用mybatis plus 框架，调用了 saveOrUpdate(user) 方法，则在前端 
 此 方法 中，与添加 方法共用，即 共用 一个表单
`

---

### 删除 单项
 - 引入 气泡弹窗
    `注意要把弹窗 包裹住 删除按钮`
```vue
    <el-popconfirm
             confirm-button-text='好的'
             cancel-button-text='不用了'
             icon="el-icon-info"
             icon-color="red"
             title="是否确认删除?"
             @confirm="handleDelete(scope.row.id)"
     >
         <el-button style="margin-left: 2px;"
                 size="mini"
                 type="danger"
                 slot="reference">删除</el-button>
     </el-popconfirm>
```
##### 注意：
@confirm="handleDelete(scope.row.id) 用于根据 用户id 作为删除参数
slot="reference"  如果不加此属性，按钮会 不显示

 - 删除方法
 ```js
    //数据删除
    handleDelete(id) {
        request("/user/delete/"+id).then(resp => {
            if (resp){
                //    删除成功
                this.load();
                this.$message({
                    message: '删除成功!',
                    type: 'success'
                });
            }else {
                this.$message.error("删除失败");
            }
        })
    },
 ```

---
### 批量删除
#### 需要 在后端 新定义一个方法 可利用mybatis plus 提供的 方法
 - 在Web 层 UserController.java 中
 ```
    //    根据 id 批量 删除
        @PostMapping("/deletes") //其中的id 
        public boolean deleteByIds(@RequestBody List<Integer> id){     //{1,2,3}
            return userService.removeByIds(id);  // mybatis plus 提供的 根据id 删除
        }
 ```
 - 气泡弹窗与 单个删除类似
 - 绑定的删除方法：`deleteByIds`
```
    //复选框选中后执行的方法
    handleSelectionChange(val) {
        this.multipleSelection = val;
        console.log(this.multipleSelection);

    },

    //批量删除
    deleteByIds(){
        // 将对象类型 直接转为 id数组
        // [{},{},{}] => {1,2,3}
        let ids =  this.multipleSelection.map(v => v.id);
        request.post("/user/deletes",ids).then(resp => {
            if (resp){
                //    删除成功
                this.load();
                this.$message({
                    message: '批量删除成功!',
                    type: 'success'
                });
            }else {
                this.$message.error("删除失败");
            }
        })
    },
```

---

### 划分路由

#### 侧边栏

- 在文件路径下的`components`包下，新建 Vue 组件 文件`Aside.vue`

- 将原主页中 左侧导航栏 元素 copy 到`Aside.vue`,更改原主页文件名：`Manage.vue`

  需要在`Aside.vue`中额外添加配置:

  ```js
  export default {
          name: "Aside",
          props:{
              isCollapse: Boolean,
              logoTextShow: Boolean
          },
          methods:{
              handleSelect(index){
                  console.log(index);
                  console.log(this.$router.options.routes)
  
              }
          }
  
      }
  ```

  `Manage.vue`:

  ```js
  import Aside from "../components/Aside";
  import Header from "../components/Header";
  ```

  ```js
   //		声明组件
          components:{
              Aside,
              Header
          },
  ```

  在父元素域引入子组件Aside

  ```vue
  <!--      左侧导航栏-->
              <el-aside class="el-aside" :width="sideWidth+'px'" style=" height: 100%;">
                  <Aside :is-collapse="isCollapse" :logoTextShow="logoTextShow"></Aside>
              </el-aside>
  ```

  ```js
  data(){
              return{
                  collapseBtnClass:'el-icon-s-fold',//收缩图标
                  isCollapse:false,
                  sideWidth:200,
                  logoTextShow: true,
                  breadList: [ ] // 路由集合
  
              }
          },
  ```

### 头部

##### 与左侧导航栏方法类似

- `Header.vue`

  ```vue
  <template>
      <div style=" font-size: 12px;display: flex;">
          <div style="flex: 1;font-size: 20px;">
              <span :class="collapseBtnClass" style="cursor: pointer" @click="collapse"></span>
          </div>
          <div style="text-align: right;font-size: 12px;width: 200px;"></div>
          <el-dropdown style="width: 80px;cursor: pointer">
              <i class="el-icon-setting" style="margin-right: 15px"><span>王小虎</span></i>
              <el-dropdown-menu style="margin-right: 30px" slot="dropdown" >
                  <el-dropdown-item>个人信息</el-dropdown-item>
                  <el-dropdown-item>退出</el-dropdown-item>
              </el-dropdown-menu>
          </el-dropdown>
      </div>
  </template>
  ```

  ```js
  export default {
          name: "Header",
          props: {
              collapseBtnClass: String,
              collapse: Function
          },
  
      }
  ```

- `Manage.vue`

  ```vue
  <!--        头部-->
                  <el-header class="el-header">
                      <Header :collapseBtnClass="collapseBtnClass" :collapse="collapse"></Header>
                  </el-header>
  ```

### 用户列表区域

#### 配置路由

- 将用户列表元素 抽离，至新建 `UserView.vue`

- 在`Manage.vue`引入该子组件

  ```vue
  <!--        右侧列表-->
                  <el-main>
  <!--                    表示当前页面的子路由 会在 router-view 里面显示-->
                      <router-view />
                  </el-main>
  ```

- `import UserView from "./UserView";`

- 将`Manage.vue`中涉及到表格操作的数据和方法一并 抽离至`UserView.vue`

- 在 router 文件夹下的`index.js`中配置路由

  ```js
  const routes = [
    {
      path: '/manage',
      name: 'Manage',
      component: () => import('../views/Manage.vue'),
      redirect: '/manage/home',	//当访问'/manage'时，会重定向至该路径，即访问首页
      meta: {title:"首页",show:true},
      children: [ //子路由
        {
          path: 'home',	// 注意 该路径前 不需写 /
          name: '首页',
          component: () => import('../views/Home.vue'),
          meta: {title:"首页",show:true}
        },
        {
          path: 'UserView',	// 注意 该路径前 不需写 /
          name: '用户管理',
          component: () => import('../views/UserView.vue'),
          meta: {title:"用户管理",show:true}
        }
  
      ]
    },
  ```

- 配置左侧导航栏 点击后 访问指定模块

  ```vue
  <el-menu-item index="/manage">
              <!-- 由于在index.js 中 已经为路由 / 重定向到 /home，所以该项会访问该 路径-->
              <template slot="title">
                  <i class="el-icon-s-home"></i>
                  <span slot="title">主页</span>
              </template>
          </el-menu-item>
  ```

  ```vue
  <el-menu-item index="/manage/userview">    <!-- index 用于指定 路由-->
                      <template slot="title">
                          <i class="el-icon-user-solid"></i>
                          <span slot="title">用户管理</span>
                      </template>
                  </el-menu-item>
  ```

---



### 文件导出 导入

#### 使用`hutool`工具进行文件操作

##### 导出

- 首先需要在`pom.xml`中引入依赖

  ```xml
  <!--        导入 导出 hutool-->
          <dependency>
              <groupId>cn.hutool</groupId>
              <artifactId>hutool-all</artifactId>
              <version>5.7.20</version>
          </dependency>
          <dependency>
              <groupId>org.apache.poi</groupId>
              <artifactId>poi-ooxml</artifactId>
              <version>4.1.2</version>
          </dependency>
  ```

- 在 Web 层 `UserController`中 新建 导出 export 方法

  先调用Mybatis Plus 内部`list()`查询所有数据，将数据封装为`User`类对象，再使用`hutool`框架提供的工具类`ExcelUtil`调用`getWriter`方法进行 写出到浏览器，由浏览器直接请求下载。

  ```java
  @RequestMapping("/export")
      public void export(HttpServletResponse response) throws Exception{
  
          List<User> list = userService.list();
          //通过工具类创建writer 写出到磁盘路径
          //ExcelWriter writer = ExcelUtil.getWriter(filesUploadPath + "/用户信息.xlsx");
          //在内存操作，写出到浏览器,请求下载
          ExcelWriter writer = ExcelUtil.getWriter(true);
  //        自定义别名     这里使用 hutool 的@Alies 注解，在 实体类中 为 字段添加注解
  //        writer.addHeaderAlias("username","用户名");
  //        writer.addHeaderAlias("password","密码");
  //        writer.addHeaderAlias("nickname","昵称");
  //        writer.addHeaderAlias("email","邮箱");
  //        writer.addHeaderAlias("phone","电话");
  //        writer.addHeaderAlias("address","地址");
  //        writer.addHeaderAlias("createTime","创建时间");
  
  //        一次性写出 list内的对象到excel，使用默认样式，强制输出标题
          writer.write(list,true);
  
  //        设置浏览器响应的 格式
          response.setContentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8");
          String fileName = URLEncoder.encode("用户信息","UTF-8");
          response.setHeader("Content-Disposition","attachment;filename=" + fileName + ".xlsx");
  
  //      将writer 对象 刷新到 输出流中
          ServletOutputStream out = response.getOutputStream();
          writer.flush(out,true);
          out.close();
          writer.close();
  
      }
  ```

  ##### 导入

  - 在 业务层 `UserService`接口中声明方法`importUsers(MultipartFile file)`返回类型`boolean`,用于判断是否成功

  - 在 Web 层 实现方法

    `UserService.java`：

    ```java
    
    public boolean importUsers(MultipartFile file) throws Exception{
            InputStream inputStream = file.getInputStream();
            ExcelReader reader = ExcelUtil.getReader(inputStream);
    //        List<UserLogin> list = reader.readAll(UserLogin.class);
            List<User> list = reader.read(0, 1, User.class);
    
            saveBatch(list);
    
            return true;
        }
    ```

    `UserController.java`：

    ```java
    /**
         * excel 导入
         *
         **/
        @PostMapping("/import")
        public boolean importUsers(MultipartFile file) throws Exception{
    
            return userService.importUsers(file);
        }
    
    ```

    #### 前端进行接口调用

    #### 导出

    ```vue
    <el-button type="info" @click="exportUsers" class="ml-5" round>导出 <i class="el-icon-upload2"></i></el-button>
    ```

    ```js
    //    导出
                exportUsers(){
                    window.open("http://localhost:8081/user/export");
                }
    ```

    #### 导入

    ```vue
    <el-upload action="http://localhost:8081/user/import"
                           :show-file-list="false"
                           :accept="xlsx"
                           :on-success="handleImportSuccess"
                           style="display: inline-block;margin-left: 5px;">
                    <el-button type="info" round>导入<i class="el-icon-download"></i></el-button>
                </el-upload>
    ```

    ```js
    //    导入
                handleImportSuccess(){
                    this.$message.success("文件上传成功");
                    this.load();
                },
    ```

    

  ###  登录
  
  #### 后端编写 登录接口
  
  - `UserController` 设置登录 路径路由接口 `/login`
  
    ```java
    //    登录
        @PostMapping("/login")
        public boolean loginIn(@RequestBody UserLogin userLogin){
    //      RequestBody 将前端传来的 json 转为 java 对象
    
            return userService.login(userLogin);
        }
    ```
  
  - `UserService` 声明`login()`带参 `UserLogin` 实体类型
  
    这边另外 写一个 实体类`UserLogin`，只需声明用户名、密码即可。用于登录、注册使用，与原`User`实体互不影响
  
    ```java
     private static final Log LOG = Log.get();
    
    //    登录
    public boolean login(UserLogin userLogin) {
        String username = userLogin.getUsername();
        String password = userLogin.getPassword();
    
        if (StrUtil.isBlank(username) || StrUtil.isBlank(password)){   // hutool 提供工具类，判断是否为空
            return false;
        }else {
            QueryWrapper<User> queryWrapper = new QueryWrapper<>();
            queryWrapper.eq("username", userLogin.getUsername());
            queryWrapper.eq("password", userLogin.getPassword());
            /**
             * 方法二：
             * @return boolean
             **/
    //        User one = getOne(queryWrapper);    //当数据中查出的数据 是重复的字段名时，这种方法不适用
    //            List<User> list = list(queryWrapper);
    //            return  list.size() != 0;
    
            /**
             * 方法一：
             * @return boolean
             **/
            try {
                User one = getOne(queryWrapper);
                return one != null;
            } catch (Exception e) {
                LOG.error(e);
                return false;
            }
    
    
        }
    ```
  
  #### 前端
  
  - 新引入vue视图：`Login.vue`，在`index.js`中引入路由
  
    ```js
    //  登录
    {
      path: '/login',
      name: '登录',
      component: () => import('../views/Login.vue')
    }
    //注意要 与主路由并列，不是子路由
    ```
  
    设置页面 样式，使用 `Element`组件，--表单验证--，
  
    ```vue
    <div class="wrapper">
            <div style="margin: 200px auto; background-color: rgba(255,250,250,0.3); width: 350px; height: 300px;padding: 20px;border-radius: 10px">
                <div style="margin: 20px 0;text-align: center;color: rgba(255,250,250,0.7); font-size: 24px"><b>登 录</b></div>
                <el-form :model="user" :rules="rules" ref="userForm">
    <!--        v-model双向绑定，会根据你输入的值，自动传入到form中进行校验，
                要不然它拿不到你输入的值，所以就一直提示你没填信息
                vue 使用DOM对象，ref -->
                    <el-form-item  prop="username">
                        <el-input size="medium"  style=" opacity: 0.5; margin: 10px 0" prefix-icon="el-icon-user" v-model="user.username" placeholder="请输入用户名"></el-input>
                    </el-form-item>
                    <el-form-item  prop="password">
                        <el-input type="password"  size="medium" style=" opacity: 0.5; margin: 10px 0" prefix-icon="el-icon-lock" v-model="user.password" show-password placeholder="请输入密码"></el-input>
                    </el-form-item>
                    <el-form-item style="margin: 10px 0; text-align: center">
                        <el-button type="primary" @click="LoginIn" size="small" autocomplete="off">登录</el-button>
                        <el-button type="primary" @click="LoginUp" size="small" autocomplete="off">注册</el-button>
                    </el-form-item>
                </el-form>
            </div>
        </div>
    ```
  
    ```js
    export default {
            name: "Login",
            data(){
                return{
                    user:{
                        username: '',
                        password: ''
                    },
                    rules: {
                        username: [
                            {required: true, message: '请输入用户名', trigger: 'blur'},
                            {min: 3, max: 11, message: '长度在 3 到 5 个字符', trigger: 'blur'}
                        ],
                        password: [
                            {required: true, message: '请输入用户名', trigger: 'blur'},
                            {min: 3, max: 20, message: '长度在 3 到 5 个字符', trigger: 'blur'}
                        ]
                    }
                }
            },
            methods:{
                LoginIn(){
                    // vue 使用DOM对象语法格式
                    this.$refs['userForm'].validate((valid) => {
                        if (valid) {    //合法
                            this.request.post("/user/login",this.user).then(res => {
                                if (!res){
                                    this.$message.error("用户名或密码错误!")
                                }else {
                                    this.$router.push("/home")
                                }
                            })
                        } else {
                            return false;
                        }
                    });
                },
                LoginUp(){
    
                },
            }
        }
    ```
  
    ```css
    .wrapper{
        height: 100vh;
        background-image: linear-gradient(to bottom right, #f69d92,#87CEFA);
        overflow: hidden;
    }
    ```

---

### 统一 包装类，用于 统一 接口的 返回类型

- `Result.java`

  ```java
  //统一 包装类，用于 统一 接口的 返回类型
  @Data
  @NoArgsConstructor
  @AllArgsConstructor
  public class Result {
  
      private String code;    // 告知是否 请求成功 或失败
      private String meg;     //如果请求失败，告知原因
      private Object data;    //后台所需要的 携带数据，可以为任何类型
  
  //    返回成功 时的 方法
      public static Result success(){
          return new Result(Constants.CODE_200,"",null);
      }
  //    返回成功 时的 有数据方法
      public static Result success(Object data){
          return new Result(Constants.CODE_200,"",data);
      }
  
  //    返回失败 时 默认 的 方法
      public static Result error(){
          return new Result(Constants.CODE_500,"系统错误",null);
      }
  //    返回失败 时的 方法
      public static Result error(String code,String msg){
          return new Result(code,msg,null);
      }
  
  
  }
  ```

#### 自定义 异常类

```java
@ControllerAdvice
public class MyExceptionHandler {

    /**
     * 自定义异常
     * @param e
     * @return
     */
    @ExceptionHandler(ServiceException.class)
    @ResponseBody
    public Result exceptionHandler(ServiceException e){
        return Result.error(e.getCode(),e.getMessage());
    }
}
```

```java
@Getter
public class ServiceException extends RuntimeException {
    private String code;

    public ServiceException(String code, String msg) {
        super(msg);
        this.code = code;
    }
}
```



#### 修改之前 登录方法，使用`Result`包装修饰

`UserController`

```java
//    登录
    @PostMapping("/login")
    public Result loginIn(@RequestBody UserLogin userLogin) {
//      RequestBody 将前端传来的 json 转为 java 对象
        String username = userLogin.getUsername();
        String password = userLogin.getPassword();

        if (StrUtil.isBlank(username) || StrUtil.isBlank(password)) {   // hutool 提供工具类，判断是否为空
            return Result.error(Constants.CODE_400, "参数错误");
        } else {
            UserLogin login = userService.login(userLogin);

            return Result.success(login);
        }
    }
```

`UserService`

```java
public UserLogin login(UserLogin userLogin) {


            /**
             * 方法二：
             * @return boolean
             **/
    //        User one = getOne(queryWrapper);    //当数据中查出的数据 是重复的字段名时，这种方法不适用
    //            List<User> list = list(queryWrapper);
    //            return  list.size() != 0;

            /**
             * 方法一：
             * @return boolean
             **/
        User one = getUserInfo(userLogin);

        if (one != null){
                BeanUtil.copyProperties(one,userLogin,true);
                return userLogin;
            } else {
                throw new  ServiceException(Constants.CODE_600,"用户名或密码错误");
            }
    }
```

其中` getUserInfo`因为需要写重复代码 ( 注册时 ) ，所有将其抽离出作为单独方法

```java
private User getUserInfo(UserLogin userLogin){
        QueryWrapper<User> queryWrapper = new QueryWrapper<>();
        queryWrapper.eq("username", userLogin.getUsername());
        queryWrapper.eq("password", userLogin.getPassword());

        User one;
        try {
            one = getOne(queryWrapper);    //从数据库中 查询用户信息
        } catch (Exception e) {
            LOG.error(e);
            throw new  ServiceException(Constants.CODE_500,"系统错误");
        }
        return one;
    }
```

#### 由于后端修改了 接口返回值，所以需要在前端 调用接口 接收数据时，需要修改参数

```js
LoginIn(){
                this.$refs['userForm'].validate((valid) => {
                    if (valid) {    //合法
                        this.request.post("/user/login",this.user).then(res => {
                            if (res.code === '200'){
                                localStorage.setItem("userIn",JSON.stringify(res.data));//将用户信息存入到浏览器
                                this.$router.push("/home");
                                this.$message.success("登录成功")
                            }else {
                                this.$message.error(res.meg)
                            }
                        })
                    }
                });
            }
```

### 注册

#### 后端编写 注册接口，供前端调用

`UserController`

```java
//    注册
    @PostMapping("/register")
    public Result register(@RequestBody UserLogin userLogin){
        String username = userLogin.getUsername();
        String password = userLogin.getPassword();

        if (StrUtil.isBlank(username) || StrUtil.isBlank(password)) {   // hutool 提供工具类，判断是否为空
            return Result.error(Constants.CODE_400, "参数错误");
        }
        User register = userService.register(userLogin);

        return Result.success(register);
    }
```

`UserService`

```java
//  注册
    public User register(UserLogin userLogin) {

        User one = getUserInfo(userLogin);
        if (one == null){
            one = new User();
            BeanUtil.copyProperties(userLogin,one,true);
            save(one);  // 把 copy 完之后的用户对象存储到 数据库
        } else {
            throw new  ServiceException(Constants.CODE_600,"用户名已存在");
        }

        return one;
    }

```

#### 前端页面使用 之前添加 用户时的表单，将用户所以信息添加至数据库

`记得将Register.vue`添加至`index.js`路由中，

```vue
<div class="wrapper">
        <div style="margin: 100px auto; background-color: rgba(255,250,250,0.3); width: 350px; height: 530px;padding: 20px;border-radius: 10px">
            <div style="margin: -5px 0 20px 0;text-align: center;color: rgba(255,250,250,0.7); font-size: 24px"><b>注
                册</b></div>
            <el-form :model="user" :rules="rules" ref="userForm">
                <el-form-item prop="username">
                    <el-input size="medium" style=" opacity: 0.5; margin: 5px 0" prefix-icon="el-icon-user"
                              v-model="user.username" placeholder="请输入用户名"></el-input>
                </el-form-item>
                <el-form-item prop="password">
                    <el-input type="password" size="medium" style=" opacity: 0.5; margin: 5px 0"
                              prefix-icon="el-icon-user" v-model="user.password" placeholder="请输入密码"></el-input>
                </el-form-item>
                <el-form-item prop="nickname">
                    <el-input size="medium" style=" opacity: 0.5; margin: 5px 0" prefix-icon="el-icon-user"
                              placeholder="请输入昵称" v-model="user.nickname"></el-input>
                </el-form-item>
                <el-form-item prop="phone">
                    <el-input size="medium" style=" opacity: 0.5; margin: 5px 0" prefix-icon="el-icon-user"
                              placeholder="请输入电话" v-model="user.phone"></el-input>
                </el-form-item>
                <el-form-item prop="email">
                    <el-input size="medium" style=" opacity: 0.5; margin: 5px 0" prefix-icon="el-icon-user"
                              placeholder="请输入邮箱" v-model="user.email"></el-input>
                </el-form-item>
                <el-form-item prop="address">
                    <el-input type="textarea" size="medium" style=" opacity: 0.5; margin: 10px 0"
                              prefix-icon="el-icon-user" placeholder="请输入地址" v-model="user.address"></el-input>
                </el-form-item>
                <el-form-item style="margin: 10px 0; text-align: center">
                    <el-button type="primary" @click="addUser" size="small" autocomplete="off">提交</el-button>
                    <el-button type="primary" size="small" @click="$router.push('/')" autocomplete="off">取消</el-button>
                </el-form-item>
            </el-form>
        </div>
    </div>
```

```js
export default {
        name: "Register",
        data() {
            const validateNum = (rule, value, callback) => {
                debugger
                const phone = /^1\d{10}$/    //以1开头的数字
                //const phone= /^[0-9]*$/
                // console.log(phone.test(value))
                // console.log(value)
                if (!(phone.test(value)) && value) {
                    callback(new Error('手机号格式不正确'))
                } else {
                    callback()
                }
            };

            return {
                user: {
                    username: '',
                    password: ''
                },
                rules: {
                    username: [
                        {required: true, message: '请输入用户名', trigger: 'blur'},
                        {min: 3, max: 11, message: '长度在 3 到 5 个字符', trigger: 'blur'}
                    ],
                    password: [
                        {required: true, message: '请输入密码', trigger: 'blur'},
                        {min: 3, max: 20, message: '长度在 3 到 20 个字符', trigger: 'blur'}
                    ],
                    nickname: [
                        {required: true, message: '请输入昵称', trigger: 'blur'},
                        {min: 2, max: 20, message: '长度在 2 到 20 个字符', trigger: 'blur'}
                    ],
                    phone: [
                        {required: true, message: '请输入手机号', trigger: 'blur'},
                        {min: 11, max: 11, message: '请输入11位手机号', trigger: 'blur'},
                        {validator: validateNum, trigger: "blur"}
                    ],
                    email: [
                        {required: true, message: '请输入邮箱', trigger: 'blur'},
                        {min: 3, max: 20, message: '长度在 3 到 5 个字符', trigger: 'blur'}
                    ],
                    address: [
                        {required: true, message: '请输入地址', trigger: 'blur'},
                        {min: 3, max: 20, message: '长度在 3 到 5 个字符', trigger: 'blur'}
                    ]
                }
            }
        },
        methods: {
            addUser() {
                if ((this.user.username !== null && this.user.username !== "") &&
                    (this.user.password !== null && this.user.password !== "") &&
                    (this.user.nickname !== null && this.user.nickname !== "") &&
                    (this.user.phone !== null && this.user.phone !== "") &&
                    (this.user.email !== null && this.user.email !== "") &&
                    (this.user.address !== null && this.user.address !== ""))
                {
                    this.request.post("/user/register", this.user).then(resp => {
                        if (resp) {
                            //    添加成功
                            this.$message({
                                message: '注册成功!',
                                type: 'success'
                            });
                            this.$router.push("/");
                        } else {
                            this.$message.error("注册失败");
                        }

                    });
                }else {
                    this.$message.error("请填写完整信息！");
                }

            },
            // cancel() {
            //     this.$router.push("/");
            // }

        }
    }
```

##### 登录成功后，从已经在本地存储中 存入的数据 读取出，昵称和 用户头像URL，动态设置头部元素

`Header.vue`

```vue
<el-dropdown style="width: 110px;cursor: pointer">
    <div style="display: inline-block">
        <img style="width: 30px;border-radius: 50%;position: relative;top: 10px;right: 15px;" :src="userIn.avatar" alt="">
        <i class="el-icon-setting" style="margin-right: 15px"><span>{{ userIn.nickname}}</span></i>
    </div>
    <el-dropdown-menu style="margin-right: 30px" slot="dropdown" >
        <el-dropdown-item>
            <el-button style=" font-size: 14px; padding: 5px 0; text-decoration: none;color: #B3C0D1;border: none;"
                    @click="handleEdit()">个人信息</el-button>
        </el-dropdown-item>
        <el-dropdown-item>
            <el-button style=" font-size: 14px; padding: 5px 0; text-decoration: none;color: #B3C0D1;border: none;" @click="loginOut">退出</el-button>
        </el-dropdown-item>
    </el-dropdown-menu>
</el-dropdown>
```

```js
data(){
	return{
        formTitle: '',
        form: { },
        dialogVisible: false,
        userIn:localStorage.getItem("userIn") ? JSON.parse(localStorage.getItem("userIn")) : {}
          }
        },
        props: {
            collapseBtnClass: String,
            collapse: Function
        },
        methods:{
            loginOut(){
                this.$router.push("/login");
                localStorage.removeItem("userIn");
                this.$message.success("退出成功");
            }
        }
```

#### 个人信息 依旧使用 el-dialog

- <el-dialog>

- 点击个人信息调用方法

  ```js
  handleEdit() {
                  this.form = this.userIn; //将row拷贝到空对象中，解决没点确定 表中数据改变的问题
                  this.dialogVisible = true;
                  this.formTitle = '个人信息';
              }
  ```

---

### JWT

​	全称：`Json web token`。他将用户信息加密 到 token 中，服务器不保存任何用户信息。服务器通过使用保存的密钥验证token的正确性，只要正确即通过验证。

#### 优点

1.  简介：可以通过 URL、POST参数或者在HTTP header发送，因为数据量小，传输速度也很快；
2. 自包含：负载中可以包含用户所需要的信息，避免了多次查询数据库；
3. 因为Token 是以 JSON加密的形式保存在客户端的，所以JWT是跨语言的，原则上任何web形式都支持；
4. 不需要在服务端保存会话信息，特别适用于分布式微服务

#### 缺点

1. 无法作废已颁布的令牌；
2. 不易应对数据过期

### Jwt 消息构成

#### 1.1 组成

​	一个token 分3部分，按顺序为：

		1. 头部 header
		1. 载荷 payload
		1. 签证 signature

三部分之间用 . 号 分隔。例如

```
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIxYzdiY2IzMS02ODFlLTRlZGYtYmU3Yy0wOTlkODAzM2VkY2UiLCJleHAiOjE1Njk3Mjc4OTF9.wweMzyB3tSQK34Jmez36MmC5xpUh15Ni3vOV_SGCzJ8
```

#### 1.2 header

`Jwt`的头部承载两部分信息：

1. 声明类型，这里是`Jwt`
2. 声明加密的算法 通常直接使用 `HMAC SHA256`

`Jwt`里验证和签名使用的算法列表如下：

| JWS   | 算法名称 |
| :---- | :------- |
| HS256 | HMAC256  |
| HS384 | HMAC384  |
| HS512 | HMAC512  |
| RS256 | RSA256   |
| RS384 | RSA384   |
| RS512 | RSA512   |
| ES256 | ECDSA256 |
| ES384 | ECDSA384 |
| ES512 | ECDSA512 |

#### 1.3 playload

载荷就是存放有效信息的地方。基本上填`2`种类型数据

1. 标准中注册的声明的数据；
2. 自定义数据。

由这2部分内部做`base64`加密。

- 标准中注册的声明 (建议但不强制使用)

```vbnet
iss: jwt签发者
sub: jwt所面向的用户
aud: 接收jwt的一方
exp: jwt的过期时间，这个过期时间必须要大于签发时间
nbf: 定义在什么时间之前，该jwt都是不可用的.
iat: jwt的签发时间
jti: jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。
```

- 自定义数据:存放我们想放在`token`中存放的`key-value`值

#### 1.4 signature

`Jwt`的第三部分是一个签证信息，这个签证信息由三部分组成
`base64`加密后的`header`和`base64`加密后的`payload`连接组成的字符串，然后通过`header`中声明的加密方式进行加盐`secret`组合加密，然后就构成了`Jwt`的第三部分。

## 二、`Spring Boot`和`Jwt`集成示例

![image-20220507155122560](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220507155122560.png)

#### 2.1导入依赖

```xml
<!--        JWT-->
        <dependency>
            <groupId>com.auth0</groupId>
            <artifactId>java-jwt</artifactId>
            <version>3.10.3</version>
        </dependency>
```

#### 2.2 Token生成

```java
/**
 * 生成token
 * @return null
 **/
public class TokenUtils {

    public static String genToken(String userId,String sign){

        return JWT.create().withAudience(userId)   //将 userId 保存到 token 里面，作为 载荷
                .withExpiresAt(DateUtil.offsetHour(new Date(), 2)) //设置 2h 后过期
                .sign(Algorithm.HMAC256(sign)); //以 password 作为 token 的密钥

    }
}
```

#### 2.3拦截器拦截token

```java
public class JwtInterceptor implements HandlerInterceptor {

    @Autowired
    private UserService userService;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        String token = request.getHeader("token");
        // 如果不是映射到方法直接通过
        if(!(handler instanceof HandlerMethod)){
            return true;
        }
        //执行认证
        if (StrUtil.isBlank(token)){
            throw new ServiceException(Constants.CODE_401,"no token，please re-login");
        }

//        获取 token中 的user id
        String userId;
        try {
            userId = JWT.decode(token).getAudience().get(0);
        } catch (JWTDecodeException e) {
            throw new ServiceException(Constants.CODE_401,"验证token 失败，请重新登录");
        }

//        根据 token中的 userId，查询用户信息
        User user = userService.getById(userId);
        if (user == null) {
            throw new ServiceException(Constants.CODE_401,"用户不存在，请重新登录");
        }

        // 验证 token，用户 密码 加签验证
        JWTVerifier jwtVerifier = JWT.require(Algorithm.HMAC256(user.getPassword())).build();
        try {
            jwtVerifier.verify(token);
        } catch (JWTVerificationException e) {
            throw new ServiceException(Constants.CODE_401, "验证token 失败，请重新登录");
        }
            return true;
    }

}

```

#### 2.4 注册拦截器

```java
@Configuration
public class InterceptorConfig implements WebMvcConfigurer {

//
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(jwtInterceptor())
                .addPathPatterns("/**")
                .excludePathPatterns(
                        "/user/login",
                        "/user/register"
                        );

        //注册TestInterceptor拦截器
//        InterceptorRegistration registration = registry.addInterceptor(jwtInterceptor());
//        registration.addPathPatterns("/**");                      //添加拦截路径
//        registration.excludePathPatterns(                         //添加不拦截路径
//            "/**/*.html",            //html静态资源
//            "/**/*.js",              //js静态资源
//            "/**/*.css",             //css静态资源
//            "/**/*.woff",
//            "/**/*.ttf",
//            "/swagger-ui.html"
//        );
    }
//    注册至 spring 容器中
    @Bean
    public JwtInterceptor jwtInterceptor() {
        return new JwtInterceptor();
    }
}	
```

#### 2.5 UserController 调用 UserService接口中的登录方法

`UserService`

```java
//    登录
    public UserLogin login(UserLogin userLogin) {

        User one = getUserInfo(userLogin);

        if (one != null){
                BeanUtil.copyProperties(one,userLogin,true);
                //设置 Token
            String token = TokenUtils.genToken(one.getId().toString(), one.getPassword());
            userLogin.setToken(token);
            return userLogin;
            } else {
                throw new  ServiceException(Constants.CODE_600,"用户名或密码错误");
            }
    }
```

#### 2.6 前端 index.js 路由 设置 token

```js
//  设置token
//  request 拦截器
//  可以对请求发送前 对请求做一些处理
//  比如统一加 token，对请求参数统一加密
request.interceptors.request.use(config => {
  config.headers['Content-Type'] = 'application/json;charset=utf-8';
  //从本地获取 数据
  let user = localStorage.getItem("userIn") ? JSON.parse(localStorage.getItem("userIn")) : null;
  if (user) {
    config.headers['token'] = user.token; //设置请求头
  }else {
    router.push("/login")
  }
  return config
},error => {
  return Promise.reject(error)
});
```

### 文件上传

- 首先定义Files实体类

  声明文件具有的属性（id，文件名称，文件类型，文件大小，地址，标识是否被删除，标识状态，md5）

  ```java
  @Data
  @TableName("sys_file")
  public class Files {
  
      @TableId(type = IdType.AUTO)
      private Integer id;
      private String name;
      private String type;
      private Long size;
      private String url;
  
      private Boolean isDelete;
  
      private Boolean enable;
      private String md5;
  }
  
  ```

- 创建sys_file数据表

- 创建Web层`FileController`，注解注入（`@RestController`+`@RequestMapping("/xxx")`）

- 创建dao数据层`FileMapper`接口 继承`BaseMapper<Files>`(BaseMapper是mybatis plus提供的)

#### 查询数据库中 file 数据

- 使用`mybatis plus`提供的分页查询

  首先 注入mapper，@Resource注解

  ```java
  	@Resource
  	private FileMapper fileMapper;
  ```

  其次声明查询方法

  ```java
  	@GetMapping("/page")
  	public Result findPage(@RequestParam Integer pageNum,
  						   @RequestParam Integer pageSize,
  						   @RequestParam(defaultValue = "") String name){
  		QueryWrapper queryWrapper = new QueryWrapper<>();
          queryWrapper.orderByDesc("id");	//根据id 降序排序
          queryWrapper.eq("is_delete",0);	//查询数据库中 没有被删除的文件
          if(!"".equals(name)){
              queryWrapper.like("name",name);
          }
          return Result.success(fileMapper.selectPage(new Page<>(pageNum,pageSize),queryWrapper));
      }
  ```

#### 文件上传

- `MultipartFile`是org.springframework.web.multipart包下的一个类，必须引入spring框架，一般使用`MultipartFile`这个类来 实现以表单的形式进行文件长传功能

- `FileUtil`文件工具类，是hutool提供的，用于获取输入流

- `IdUtil`id标识码工具类，生成通用的唯一标识码

- `StrUtil`字符串工具类，常用的有：`isBlank`、`isNotBlan`、`isEmpty`、`isNotEmpty`用于判空

  [可查看](https://www.wenjiangs.com/doc/szo7bkk2)

- `SecureUtil`加密解密工具类

- 定义文件上传的路径：在yml配置文件中，

  ```yaml
  files:
    upload:
      path: G://xx/xx/files/
  ```

- 定义变量 注入路径

  ```java
  @Value("${files.upload.path}")
  private String fileUploadPath;
  ```

```java
	@Post("/upload")
	public Result upload(@RequestParam MultipartFile file) throws IOException{
        String originalFile = file.getOriginalFilename();	//获取文件原名称
        String type = FileUtil.extName(originalFile);	//获取文件类型
    	long size = file.getSize();
        
     //定义 一个文件的 唯一标识码
        String uuid = IdUtil.fastSimpleUUID();
        String fileUuid = uuid + StrUtil.DOT + type;
        
        File uploadFile = new File(fileUploadPath + fileUuid);
      //判断父级文件夹是否存在
        File parentFile = uploadFile.getParentFile();
        if(!parentFile.exists()){
            parentFile.mkdirs();
        }
        //获取文件 url
        String url;
        //上传文件到磁盘
        file.transferTo(uploadFile);
        //先判断文件是否存在，当文件存在的时候，再获取文件的md5
        //获取文件的 md5 格式
        String md5 = SecureUtil.md5(uploadFile);
        //查询数据库 是否有md5 重名的文件
        File dbFiles = getFileByMd5(md5);
        if(dbFiles != null){
            url = dbFiles.getUrl();
            uploadFile.delete();
        }else{
            //如果 数据库若不存在重复的文件，则不删除刚才上传的文件
            url = "http://localhost:8081/file/" + fileUuid;
        }
        
        //存储数据库
        Files saveFile = new Files();
        saveFile.setName(originalFilename);
        saveFile.setType(type);
        saveFile.setSize(size / 1024); 	//从 b 转为kb
        saveFile.setUrl(url);
        saveFile.setMd5(md5);
        fileMapper.insert(saveFile);
        
        return url;
    }
```

```java
/**
     * 通过文件的 md5 查询文件
     *
     * @return com.example.vuemanage.domain.Files
     **/
    private Files getFileByMd5(String md5) {
        QueryWrapper<Files> queryWrapper = new QueryWrapper<>();
        queryWrapper.eq("md5", md5);
        List<Files> files = fileMapper.selectList(queryWrapper);

        return files.size() == 0 ? null : files.get(0);
    }
```

#### 文件下载

​	文件下载路径：http://localhost:8081/file/{fileUuid}

```java
@GetMapping("/{fileUuid}")
    public void download(@PathVariable String fileUuid, HttpServletResponse response) throws IOException {
//        根据文件的唯一标识码，获取文件
        File uploadFile = new File(fileUploadPth + fileUuid);
//        设置输出流的格式
        ServletOutputStream os = response.getOutputStream();
        response.setHeader("Content-Disposition", "attachment;filename=" + URLEncoder.encode(fileUuid, "UTF-8"));
        response.setContentType("application/octet-stream");

//        读取文件的字节流
        os.write(FileUtil.readBytes(uploadFile));
        os.flush();
        os.close();
    }
```

#### 更新 文件状态

```java
@PostMapping("/enable")
    public Result save(@RequestBody Files files){

        return Result.success(fileMapper.updateById(files));
    }
```

#### 删除文件 根据 id

```java
//    根据 id 删除
    @RequestMapping("/delete/{id}") //其中的id @PathVariable 声明的 id 对应
    public Result delete(@PathVariable Integer id){
        Files files = fileMapper.selectById(id);
        files.setIsDelete(true);
        return Result.success(fileMapper.updateById(files)) ;  // mybatis plus 提供的 根据id 删除
    }
```

#### 批量删除文件 ids

```java
//    根据 id 批量 删除
    @PostMapping("/deletes") //其中的id
    public Result deleteByIds(@RequestBody List<Integer> ids){     //{1,2,3}
//        select * from sys_file where id in(id,id,id..)
        QueryWrapper<Files> queryWrapper = new QueryWrapper<>();
        queryWrapper.in("id",ids);
        List<Files> files = fileMapper.selectList(queryWrapper);
        for (Files file : files){
            file.setIsDelete(true);
            fileMapper.updateById(file);
        }
        return Result.success();
    }
```

### 前端

### 新建 文件展示页面 `File.vue`

- `router/index.js` 引入路由

  ```js
  	{
          path: 'file',
          name: '文件管理',
          component: () => import('../views/File.vue'),
        }
  ```

- `Aside.vue`导航栏中设置对应访问路径`index="/file"`

- `File.vue`编写样式

#### 展示文件数据

```vue
<el-table
                :data="tableData" border stripe
                :header-cell-class-name="headerBg"
                @selection-change="handleSelectionChange">
            <!--            多选框-->
            <el-table-column
                    type="selection"
                    align="center"
                    width="50">
            </el-table-column>
            <el-table-column  prop="id" align="center" label="ID" width="40"></el-table-column>
            <el-table-column prop="name" align="center" label="文件名称"></el-table-column>
            <el-table-column prop="type" align="center" label="文件类型"></el-table-column>
            <el-table-column prop="size" align="center" label="文件大小(kb)"></el-table-column>
            <el-table-column align="center" label="下载">
                <template slot-scope="scope">
                    <el-button type="primary" @click="download(scope.row.url)">下载</el-button>
                </template>
            </el-table-column>
            <el-table-column prop="enable" align="center" label="启用">
                <template slot-scope="scope">
                    <el-switch v-model="scope.row.enable"
                               active-color="#13ce66"
                               inactive-color="#ccc"
                               @change="changeEnable(scope.row)"

                    ></el-switch>
                </template>
            </el-table-column>
            <el-table-column fixed="right"
                             label="操作"
                             align="center"
                             width="150">
                <template slot-scope="scope">

                    <el-popconfirm
                            confirm-button-text='好的'
                            cancel-button-text='不用了'
                            icon="el-icon-info"
                            icon-color="red"
                            title="是否确认删除?"
                            @confirm="handleDelete(scope.row.id)"
                    >
                        <el-button style="margin-left: 2px;"
                                   size="mini"
                                   type="danger"
                                   slot="reference">删除</el-button>
                    </el-popconfirm>
                </template>

            </el-table-column>
        </el-table>
		<div style="padding: 10px 0">
            <!--
            current-page：当前页码
            page-sizes：分页条件数
            page-size：分页大小-->
            <el-pagination
                    @size-change="handleSizeChange"
                    @current-change="handleCurrentChange"
                    :current-page="pageNum"
                    :page-sizes="[2, 5, 10, 20]"
                    :page-size="pageSize"
                    layout="total, sizes, prev, pager, next, jumper"
                    :total="total">
            </el-pagination>
        </div>
```

```js
		data(){
            return{
                tableData: [],
                multipleSelection: [],
                pageNum: 1,
                pageSize: 5,
                total: 0,
                name: '',
                isDelete: false,
                headerBg:'headerBg'
            }
        },
        mounted() {
            this.load();
        },
        methods:{

            load(){
                this.request.get("/file/page",{
                    params: {
                        pageNum:this.pageNum,
                        pageSize:this.pageSize,
                        name:this.name
                    }
                }).then(req => {
                        this.tableData = req.data.records;
                        this.total = req.data.total;

                })

            },
            //复选框选中后执行的方法
            handleSelectionChange(val) {
                this.multipleSelection = val;
                console.log(this.multipleSelection);

            },
            //分页
            handleSizeChange(pageSize) {
                this.pageSize = pageSize;
                if (this.username ==null && this.email == null && this.address == null){
                    this.load();
                }else {
                    this.selectByCondition();
                }

            },
            handleCurrentChange(pageNum) {
                this.pageNum = pageNum;
                this.selectByCondition();
            },

            //表格数据操作
            handleEdit(row) {
                // this.form = row;
                this.form = Object.assign({},row); //将row拷贝到空对象中，解决没点确定 表中数据改变的问题
                this.dialogVisible = true;
                this.formTitle = '修改用户信息';
            },
            //设置 状态
            changeEnable(row){
                this.request.post("/file/enable",row).then(res => {
                    if (res.code === '200'){
                        this.$message.success("操作成功");

                    }else{
                        this.$message.error("操作失败");
                    }
                })
            },
            //数据删除
            handleDelete(id) {
                this.request("/file/delete/"+id).then(resp => {
                    if (resp.code === '200'){
                        //    删除成功
                        this.$message.success("删除成功");
                        this.load();
                    }else {
                        this.$message.error("删除失败");
                    }
                })
            }
        }
```

#### 功能区

```vue
<!--        顶部搜索框 -->
        <div style="margin: 10px 0">
            <el-input class="ml-5" v-model="name" style="width: 200px;" suffix-icon="el-icon-edit" placeholder="请输入姓名"></el-input>
            <el-button style="margin-left: 5px;" type="primary" icon="el-icon-search" @click="load">搜索</el-button>
            <el-button style="margin-left: 5px;" type="warning"  @click="reset">重置</el-button>
        </div>
<!--        功能区 上传文件 批量删除-->
        <div style="margin: 10px 0">
            <el-upload action="http://localhost:8081/file/upload"
                       :show-file-list="false"
                       :on-success="handleFileUploadSuccess"
                       style="display: inline-block;margin-left: 5px;">
                <el-button type="info" round>上传文件<i class="el-icon-upload"></i></el-button>
            </el-upload>
            <el-popconfirm
                    confirm-button-text='好的'
                    cancel-button-text='不用了'
                    icon="el-icon-info"
                    icon-color="red"
                    title="是否批量确认删除?"
                    @confirm="deleteByIds"
            >
                <el-button type="danger" slot="reference" class="ml-5">批量删除 <i class="el-icon-remove-outline"></i></el-button>
            </el-popconfirm>
        </div>
```

```js
handleFileUploadSuccess(){
                this.load();
            },
            //重置
            reset(){
                this.name = '';
                this.load();
            },
            //文件下载
            download(url){
                window.open(url)
            },
            //批量删除
            deleteByIds(){
                // 将对象类型 直接转为 id数组
                // [{},{},{}] => {1,2,3}
                let ids =  this.multipleSelection.map(v => v.id);
                this.request.post("/file/deletes",ids).then(resp => {
                    if (resp){
                        //    删除成功
                        this.load();
                        this.$message({
                            message: '批量删除成功!',
                            type: 'success'
                        });
                    }else {
                        this.$message.error("删除失败");
                    }
                })
            },
```

#### `Header.vue`中用户信息上传头像

- <el-form>中添加上传头像标签

```vue
<el-form-item label="头像" style="line-height: 50px;height: 50px">
                        <el-upload
                                class="avatar-uploader"
                                action="http://localhost:8081/user/add"
                                accept=".jpg,.jpeg,.png,.JPG,.JPEG"
                                :show-file-list="false"
                                :on-success="handleAvatarSuccess"
                                :before-upload="beforeAvatarUpload">
                            <img style="width: 50px;border-radius: 50%;  left: 35px; cursor: pointer;
                                        display: block;
                                        box-shadow: 3px 5px 5px rgba(135,206,235, 0.3);"
                                 v-if="form.avatar" :src="form.avatar" alt="头像" class="avatar">
                            <i v-else class="el-icon-plus avatar-uploader-icon"></i>
                        </el-upload>
                    </el-form-item>
```

```css
<style scoped>
    .avatar-uploader {
        cursor: pointer;
        position: relative;
        overflow: hidden;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 1px dotted #95b5ea;
        box-shadow: 3px 5px 5px rgba(135,206,235, 0.3);
    }
    .avatar-uploader {
        border-color: #409EFF;
    }
    .avatar-uploader-icon {
        font-size: 26px;
        color: #8c939d;
        width: 50px;
        height: 50px;
        line-height: 50px;
        text-align: center;
    }
</style>
```

### 整合Echarts

- 首先使用 `npm i echarts -S`安装`echarts`包

- 官网：https://echarts.apache.org/zh/index.html

- 在事例中直接复制代码到本地文件`Echarts.vue`

- 注意：若要显示图表，必须要用 div 包裹 eg：

  ```vue
  <div>
          <el-row>
              <el-col :span="12">
                  <div id="main" style="height: 400px;width: 500px;"></div>
              </el-col>
              <el-col :span="12">
                  <div id="pie" style="height: 400px;width: 500px;"></div>
              </el-col>
          </el-row>
      </div>
  ```

- 在 <script>中引入

  import * as echarts from 'echarts'

- 搬运代码

  ```js
  export default {
          name: "Echarts",
          data(){
              return{
  
              }
          },
          mounted() {
              //线状图
              var option= {
                  title: {
                      text: "各季度会员统计表",
                      left: 'center'
                  },
                  xAxis: {
                      type: 'category',
                      data: ['第一季度','第二季度','第三季度','第四季度']
                  },
                  yAxis: {
                      type: 'value'
                  },
                  series: [
                      {
                          data: [],
                          type: 'line'
                      }
                  ]
              };
              var chartDom = document.getElementById('main');
              var myChart = echarts.init(chartDom);
              //饼图
              var pieOption =  {
                  title: {
                      text: '各季度会员统计图',
                      subtext: '',
                      left: 'center'
                  },
                  tooltip: {
                      trigger: 'item'
                  },
                  legend: {
                      orient: 'vertical',
                      left: 'left'
                  },
                  series: [
                      {
                          name: 'uh~huh',
                          type: 'pie',
                          radius: '50%',
                          label: {
                              normal: {
                                  show: true,
                                  position: "inner",
                                  textStyle: {
                                      fontWeight: 200,
                                      fontSize: 16, //文字的字体大小
                                      color: "#fff"
                                  },
                                  formatter: "{d}%" /*饼状图内显示百分比*/,
                                  // data:['40%','60%'],
                              },
                              data: [],
                              emphasis: {
                                  itemStyle: {
                                      shadowBlur: 10,
                                      shadowOffsetX: 0,
                                      shadowColor: 'rgba(0, 0, 0, 0.5)'
                                  }
                              }
                          }
                      }
                  ]
              };
              var pieDom = document.getElementById('pie');
              var myPie = echarts.init(pieDom);
  
              // //从后台获取图表数据
              // this.request.get("/echarts/example").then(res => {
              //     option.xAxis.data = res.data.x;
              //     option.series[0].data = res.data.y;
              //     //在数据准备完毕后，再进行set
              //     myChart.setOption(option);
              // });
  
              //从后台获取图表数据
              this.request.get("/echarts/members").then(res => {
                  option.series[0].data = res.data;
                  //在数据准备完毕后，再进行set
                  myChart.setOption(option);
  
                  pieOption.series[0].data = [
                      { name: "第一季度", value: res.data[0] },
                      { name: "第二季度", value: res.data[1] },
                      { name: "第三季度", value: res.data[2] },
                      { name: "第四季度", value: res.data[3] },
                  ];
                  myPie.setOption(pieOption);
              });
  
  
  
  
  
  
  
          }
      }
  ```

  

























